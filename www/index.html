<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy"
        content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="cordova.js"></script>
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="config.js"></script>

    <script>
        let postsRef;
        let postsListener = null;
        // ç¾åœ¨ã®ç·¨é›†å¯¾è±¡ã®ID
        let currentEditId = null;
        // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶
        let currentUser = null;

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå‡¦ç†
        function showMessage(message, type = 'success') {
            const messageArea = $('#messageArea');
            messageArea.html(`
        <div class="message ${type}">
            ${message}
        </div>
    `);

            // 4ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
            setTimeout(() => {
                messageArea.find('.message').addClass('fade-out');
                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
                setTimeout(() => {
                    messageArea.empty();
                }, 300);
            }, 4000);
        }

        // èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¥æœ¬èªåŒ–
        function getAuthErrorMessage(error) {
            // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆ
            if (error.code) {
                return `èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆ${error.code}ï¼‰`;
            } else if (error.message) {
                return `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${error.message}`;
            } else {
                return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }
        }

        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°ï¼ˆæ®‹ã‚Šæ–‡å­—æ•°è¡¨ç¤ºï¼‰
        function updateCharacterCount(inputId, counterId, maxLength) {
            const input = $(`#${inputId}`);
            const counter = $(`#${counterId}`);

            // åˆæœŸè¡¨ç¤ºã®æ›´æ–°
            const updateCounter = () => {
                const length = input.val().length;
                const remaining = maxLength - length;
                counter.text(`æ®‹ã‚Š ${remaining} æ–‡å­—`);

                if (remaining < 0) {
                    counter.addClass('error');
                } else if (remaining <= 100) {
                    counter.removeClass('error').addClass('warning');
                } else {
                    counter.removeClass('error warning');
                }
            };

            // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
            updateCounter();

            // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒã‚¤ãƒ³ãƒ‰
            input.off('input').on('input', updateCounter);
        }

        // æŠ•ç¨¿å†…å®¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateContent(content) {
            if (!content || !content.trim()) {
                showMessage('æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return false;
            }
            if (content.length > 1000) {
                showMessage('æŠ•ç¨¿å†…å®¹ã¯1000æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return false;
            }
            return true;
        }

        // èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateAuthInput(email, password, isRegister = false, nickname = '') {
            if (!email || !email.trim()) {
                showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return false;
            }
            if (!password || !password.trim()) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return false;
            }
            if (isRegister && password.length < 6) {
                showMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error');
                return false;
            }
            if (isRegister && (!nickname || !nickname.trim())) {
                showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return false;
            }
            if (isRegister && nickname.length > 20) {
                showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return false;
            }
            return true;
        }

        // æŠ•ç¨¿å‡¦ç†
        function createPost(author, content) {
            if (!currentUser) {
                showMessage('æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'error');
                return;
            }

            if (!validateContent(content)) return;

            const button = $('#postButton');
            button.prop('disabled', true);

            // author ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ã®displayNameã‚’ä½¿ç”¨ã€userId ã‚’è¿½åŠ 
            const displayName = currentUser.displayName || currentUser.email;
            const postData = {
                author: displayName,
                authorEmail: currentUser.email,
                content: content,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                userId: currentUser.uid
            };

            postsRef.push(postData)
                .then(() => {
                    showMessage('æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                    $('#contentInput').val('');
                    updateCharacterCount('contentInput', 'contentCount', 1000);
                })
                .catch((error) => {
                    showMessage('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
                })
                .finally(() => {
                    button.prop('disabled', false);
                });
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
        function escapeHtml(str) {
            if (!str) return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆç›¸å¯¾æ™‚é–“è¡¨ç¤ºå¯¾å¿œï¼‰
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);

            // ç›¸å¯¾æ™‚é–“ã®è¡¨ç¤º
            let relativeTime;
            if (diffSeconds < 60) {
                relativeTime = 'ãŸã£ãŸä»Š';
            } else if (diffMinutes < 60) {
                relativeTime = `${diffMinutes}åˆ†å‰`;
            } else if (diffHours < 24) {
                relativeTime = `${diffHours}æ™‚é–“å‰`;
            } else if (diffDays < 7) {
                relativeTime = `${diffDays}æ—¥å‰`;
            } else if (diffWeeks < 4) {
                relativeTime = `${diffWeeks}é€±é–“å‰`;
            } else if (diffMonths < 12) {
                relativeTime = `${diffMonths}ãƒ¶æœˆå‰`;
            } else {
                relativeTime = `${diffYears}å¹´å‰`;
            }

            // è©³ç´°ãªæ—¥æ™‚ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ï¼‰
            const fullDate = date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            return { relativeTime, fullDate };
        }

        // æŠ•ç¨¿ã®ç·¨é›†æ¨©é™ãƒã‚§ãƒƒã‚¯
        function canEditPost(post) {
            return currentUser && post.userId === currentUser.uid;
        }

        // æŠ•ç¨¿ã®HTMLè¦ç´ ã‚’ç”Ÿæˆ
        function createPostElement(post) {
            // ç·¨é›†æ¨©é™ã‚’ç¢ºèª
            const canEdit = canEditPost(post);
            // ç·¨é›†æ¨©é™ãŒã‚ã‚Œã°ã€ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½ã‚’è¡¨ç¤º
            const actions = canEdit ? `
        <div class="post-actions">
            <button class="btn-edit" onclick="startEdit('${post.id}')">
                ç·¨é›†
            </button>
            <button class="btn-delete" onclick="startDelete('${post.id}')">
                å‰Šé™¤
            </button>
        </div>
    ` : '';

            return `
        <div class="post" id="post-${post.id}">
            <div class="post-header">
                <span class="post-author">${escapeHtml(post.author)}</span>
                <!-- ç·¨é›†æ¨©é™ãŒã‚ã‚Œã°ã€ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½ã‚’è¡¨ç¤º -->
                ${actions}
            </div>
            <div class="post-content">${escapeHtml(post.content)}</div>
            <div class="post-footer">
                <span class="post-time" title="${formatTimestamp(post.timestamp).fullDate}">
                    ${formatTimestamp(post.timestamp).relativeTime}
                </span>
                ${post.updatedAt ? `
                    <span class="post-updated" title="${formatTimestamp(post.updatedAt).fullDate}">
                        (ç·¨é›†æ¸ˆã¿: ${formatTimestamp(post.updatedAt).relativeTime})
                    </span>
                ` : ''}
            </div>
        </div>
    `;
        }

        // æŠ•ç¨¿ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displayPosts(posts) {
            const postsList = $('#postsList');
            postsList.empty();

            if (posts.length === 0) {
                postsList.html('<div class="no-posts">æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>');
                return;
            }

            posts.forEach(post => {
                postsList.append(createPostElement(post));
            });
        }

        // æŠ•ç¨¿ã®èª­ã¿è¾¼ã¿
        function loadPosts() {
            const sortOrder = $('#sortOrder').val();
            $('#loadingSpinner').show();

            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
            if (postsListener) {
                postsRef.off('value', postsListener);
                postsListener = null;
            }

            // ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            postsListener = postsRef.on('value', (snapshot) => {
                const posts = [];
                snapshot.forEach((childSnapshot) => {
                    posts.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });

                // ã‚½ãƒ¼ãƒˆé †ã®é©ç”¨
                if (sortOrder === 'newest') {
                    posts.sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    posts.sort((a, b) => a.timestamp - b.timestamp);
                }

                displayPosts(posts);
                $('#loadingSpinner').hide();
            }, (error) => {
                console.error('Data fetch error:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                $('#loadingSpinner').hide();
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
        function showModal(modalId) {
            $(`#${modalId}`).fadeIn(200);
            $('body').addClass('modal-open');
        }

        function closeModal(modalId) {
            $(`#${modalId}`).fadeOut(200);
            $('body').removeClass('modal-open');
        }

        // æ›´æ–°å‡¦ç†ã®ãƒãƒ³ãƒ‰ãƒ©
        function handleUpdate() {
            if (!currentEditId) return;

            const content = $('#editContent').val();
            if (!validateContent(content)) return;

            const updates = {
                content: content,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            postsRef.child(currentEditId).update(updates)
                .then(() => {
                    showMessage('æŠ•ç¨¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    closeModal('editModal');
                    animateUpdate(currentEditId);
                    currentEditId = null;
                })
                .catch((error) => {
                    showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
                });
        }

        // å‰Šé™¤å‡¦ç†ã®ãƒãƒ³ãƒ‰ãƒ©
        function handleDelete() {
            if (!currentEditId) return;

            const postElement = $(`#post-${currentEditId}`);
            postElement.addClass('deleting');

            postsRef.child(currentEditId).remove()
                .then(() => {
                    showMessage('æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    closeModal('deleteModal');
                    currentEditId = null;
                })
                .catch((error) => {
                    showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
                    postElement.removeClass('deleting');
                });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
        $(document).on('click', '.modal-overlay', () => {
            const modalId = $(this).parent().attr('id');
            closeModal(modalId);
        });

        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        $(document).on('keydown', (e) => {
            if (e.key === 'Escape') {
                $('.modal:visible').each(() => {
                    closeModal(this.id);
                });
            }
        });

        // ç·¨é›†ã®é–‹å§‹
        function startEdit(postId) {
            currentEditId = postId;
            const post = $(`#post-${postId}`);
            const content = post.find('.post-content').text();

            $('#editContent').val(content);
            updateCharacterCount('editContent', 'editContentCount', 1000);
            showModal('editModal');
        }

        // å‰Šé™¤ã®é–‹å§‹
        function startDelete(postId) {
            currentEditId = postId;
            showModal('deleteModal');
        }


        // æŠ•ç¨¿ã®å‰Šé™¤
        function deletePost(postId) {
            if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }

            const postElement = $(`#post-${postId}`);
            postElement.addClass('deleting');

            postsRef.child(postId).remove()
                .then(() => {
                    showMessage('æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                })
                .catch((error) => {
                    showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
                    postElement.removeClass('deleting');
                });
        }

        // æ›´æ–°æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateUpdate(postId) {
            const post = $(`#post-${postId}`);
            post.addClass('updated');
            setTimeout(() => {
                post.removeClass('updated');
            }, 1000);
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function login(email, password) {
            if (!validateAuthInput(email, password)) return;

            const button = $('#loginButton');
            button.prop('disabled', true);

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(() => {
                    showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
                    clearAuthForm();
                })
                .catch((error) => {
                    showMessage(getAuthErrorMessage(error), 'error');
                })
                .finally(() => {
                    button.prop('disabled', false);
                });
        }

        // æ–°è¦ç™»éŒ²å‡¦ç†
        function register(email, password, nickname) {
            if (!validateAuthInput(email, password, true, nickname)) return;

            const button = $('#registerButton');
            button.prop('disabled', true);

            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // displayNameã‚’è¨­å®š
                    return userCredential.user.updateProfile({
                        displayName: nickname.trim()
                    });
                })
                .then(() => {
                    showMessage('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
                    clearAuthForm();
                })
                .catch((error) => {
                    showMessage(getAuthErrorMessage(error), 'error');
                })
                .finally(() => {
                    button.prop('disabled', false);
                });
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            firebase.auth().signOut()
                .then(() => {
                    showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                })
                .catch((error) => {
                    showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                });
        }

        // è¡¨ç¤ºåã®æ›´æ–°å‡¦ç†
        function updateDisplayName(newName) {
            if (!currentUser) {
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'error');
                return;
            }

            if (!newName || !newName.trim()) {
                showMessage('æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (newName.length > 20) {
                showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            currentUser.updateProfile({
                displayName: newName.trim()
            })
                .then(() => {
                    showMessage('è¡¨ç¤ºåã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    $('#userDisplayName').text(newName.trim());
                    closeModal('nicknameEditModal');
                })
                .catch((error) => {
                    showMessage('è¡¨ç¤ºåã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
                });
        }

        // è¡¨ç¤ºåç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openNicknameEditModal() {
            const currentName = currentUser ? (currentUser.displayName || '') : '';
            $('#newNicknameInput').val(currentName);
            showModal('nicknameEditModal');
        }

        // èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¯ãƒªã‚¢
        function clearAuthForm() {
            $('#loginEmail').val('');
            $('#loginPassword').val('');
            $('#registerNickname').val('');
        }

        // UIæ›´æ–°
        function updateUI(user) {
            if (user) {
                $('.logged-in').show();
                $('.logged-out').hide();
                // displayNameãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                const displayName = user.displayName || user.email;
                $('#userDisplayName').text(displayName);
            } else {
                $('.logged-in').hide();
                $('.logged-out').show();
                $('#userDisplayName').text('');
            }
        }

        $(function () {
            // Firebaseã®åˆæœŸåŒ–
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully");
                postsRef = firebase.database().ref('posts');

                // æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                loadPosts();

            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessage('Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }

            // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
            firebase.auth().onAuthStateChanged((user) => {
                currentUser = user;
                updateUI(user);
                loadPosts();
            });

            // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®åˆæœŸåŒ–
            updateCharacterCount('contentInput', 'contentCount', 1000);

            // æŠ•ç¨¿å‡¦ç†
            $('#postButton').on('click', () => {
                // æŠ•ç¨¿å†…å®¹ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å–å¾—
                const authorVal = $('#authorInput').val();
                const contentVal = $('#contentInput').val();
                createPost(authorVal, contentVal);
            });

            $('#loginButton').on('click', () => {
                const email = $('#loginEmail').val();
                const password = $('#loginPassword').val();
                login(email, password);
            });

            $('#registerButton').on('click', () => {
                const email = $('#loginEmail').val();
                const password = $('#loginPassword').val();
                const nickname = $('#registerNickname').val();
                register(email, password, nickname);
            });

            $('#logoutButton').on('click', logout);

            // æŠ•ç¨¿ä¸€è¦§è¡¨ç¤ºé †åºé¸æŠ
            $('#sortOrder').on('change', loadPosts);

            // èƒŒæ™¯è‰²å¤‰æ›´æ©Ÿèƒ½
            const themes = [
                { name: 'default', bg: '#f8f9fa', text: '#333', card: '#ffffff' },
                { name: 'dark', bg: '#1a1a2e', text: '#eaeaea', card: '#16213e' },
                { name: 'ocean', bg: '#e3f2fd', text: '#1565c0', card: '#ffffff' },
                { name: 'forest', bg: '#e8f5e9', text: '#2e7d32', card: '#ffffff' },
                { name: 'sunset', bg: '#fff3e0', text: '#e65100', card: '#ffffff' }
            ];
            let currentThemeIndex = parseInt(localStorage.getItem('themeIndex') || '0');

            function applyTheme(index) {
                const theme = themes[index];

                // CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒ¼ãƒã‚’é©ç”¨
                document.documentElement.style.setProperty('--theme-bg', theme.bg);
                document.documentElement.style.setProperty('--theme-text', theme.text);
                document.documentElement.style.setProperty('--theme-card', theme.card);

                // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã®å ´åˆã¯è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ«
                if (theme.name === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }

                localStorage.setItem('themeIndex', index);
            }

            // åˆæœŸãƒ†ãƒ¼ãƒã‚’é©ç”¨
            applyTheme(currentThemeIndex);

            // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            $('#themeToggleBtn').on('click', () => {
                currentThemeIndex = (currentThemeIndex + 1) % themes.length;
                applyTheme(currentThemeIndex);
                showMessage(`ãƒ†ãƒ¼ãƒã‚’ã€Œ${themes[currentThemeIndex].name}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
            });
        });

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
        window.addEventListener('unload', () => {
            if (postsListener) {
                postsRef.off('value', postsListener);
                postsListener = null;
            }
        });
    </script>
</head>

<body>
    <!-- èƒŒæ™¯è‰²å¤‰æ›´ãƒœã‚¿ãƒ³ï¼ˆå›ºå®šä½ç½®ï¼‰ -->
    <div class="theme-toggle-container">
        <button id="themeToggleBtn" class="btn-theme-toggle" title="èƒŒæ™¯è‰²ã‚’å¤‰æ›´">
            ğŸ¨
        </button>
    </div>

    <div class="container">
        <h1>æ²ç¤ºæ¿ã‚¢ãƒ—ãƒª</h1>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="messageArea"></div>

        <!-- èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³æ™‚è¡¨ç¤ºï¼‰ -->
        <div class="auth-container logged-out">
            <div class="form-group">
                <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="example@example.com">
            </div>
            <div class="form-group">
                <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="6æ–‡å­—ä»¥ä¸Š">
                <small class="help-text">â€»æ–°è¦ç™»éŒ²æ™‚ã¯6æ–‡å­—ä»¥ä¸Š</small>
            </div>
            <div class="form-group register-only" id="nicknameGroup">
                <label for="registerNickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  <span class="required">â€»æ–°è¦ç™»éŒ²æ™‚ã®ã¿</span></label>
                <input type="text" id="registerNickname" class="form-control" placeholder="è¡¨ç¤ºåï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰" maxlength="20">
            </div>
            <div class="button-group">
                <button id="loginButton" class="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="registerButton" class="btn-secondary">æ–°è¦ç™»éŒ²</button>
            </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚è¡¨ç¤ºï¼‰ -->
        <div class="user-info logged-in">
            <div class="user-info-left">
                <span>ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š<span id="userDisplayName"></span></span>
                <button id="editNicknameBtn" class="btn-edit-nickname" onclick="openNicknameEditModal()"
                    title="è¡¨ç¤ºåã‚’ç·¨é›†">âœï¸</button>
            </div>
            <button id="logoutButton" class="btn-secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <!-- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚è¡¨ç¤ºï¼‰ -->
        <div class="post-form logged-in">
            <div class="form-group">
                <label for="contentInput">æŠ•ç¨¿å†…å®¹</label>
                <textarea id="contentInput" class="form-control" placeholder="æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                <small class="character-count" id="contentCount">0/1000</small>
            </div>
            <div class="button-group">
                <button id="postButton" class="btn-primary">æŠ•ç¨¿ã™ã‚‹</button>
            </div>
        </div>

        <!-- æŠ•ç¨¿ä¸€è¦§ -->
        <div class="posts-container">
            <h2>æŠ•ç¨¿ä¸€è¦§</h2>
            <div class="posts-control">
                <select id="sortOrder" class="form-control">
                    <option value="newest">æ–°ã—ã„é †</option>
                    <option value="oldest">å¤ã„é †</option>
                </select>
            </div>
            <div id="postsList" class="posts-list">
                <div class="loading">æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="editModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>æŠ•ç¨¿ã‚’ç·¨é›†</h3>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea id="editContent" class="form-control"></textarea>
                    <small class="character-count" id="editContentCount">0/1000</small>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="handleUpdate()" class="btn-primary">æ›´æ–°</button>
                <button onclick="closeModal('editModal')" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="deleteModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>æŠ•ç¨¿ã®å‰Šé™¤</h3>
                <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <p class="text-danger">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
            </div>
            <div class="modal-footer">
                <button onclick="handleDelete()" class="btn-danger">å‰Šé™¤</button>
                <button onclick="closeModal('deleteModal')" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- è¡¨ç¤ºåç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="nicknameEditModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>è¡¨ç¤ºåã®å¤‰æ›´</h3>
                <button class="modal-close" onclick="closeModal('nicknameEditModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newNicknameInput">æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
                    <input type="text" id="newNicknameInput" class="form-control" placeholder="20æ–‡å­—ä»¥å†…" maxlength="20">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="updateDisplayName($('#newNicknameInput').val())" class="btn-primary">æ›´æ–°</button>
                <button onclick="closeModal('nicknameEditModal')" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
</body>

</html>